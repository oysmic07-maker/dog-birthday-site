<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>관리자 | 방명록/참여 확인</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#070a12; --panel:#0b1220; --panel2:#0f172a; --line:#1f2937;
      --text:#e5e7eb; --muted:#94a3b8; --brand:#22d3ee; --brand2:#a78bfa;
    }
    body{
      background:
        radial-gradient(900px 480px at 15% 0%, rgba(34,211,238,.10), transparent 60%),
        radial-gradient(900px 480px at 85% 0%, rgba(167,139,250,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .card{background: rgba(11,18,32,.78); border: 1px solid rgba(31,41,55,.85); backdrop-filter: blur(10px);}
    .input{background: rgba(2,6,23,.40); border: 1px solid rgba(31,41,55,.95); color: var(--text);}
    .btn{background: linear-gradient(135deg, var(--brand), var(--brand2)); color:#071018; font-weight: 800;}
    .btn2{background: rgba(255,255,255,.06); border: 1px solid rgba(148,163,184,.20); color: var(--text); font-weight: 800;}
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-xs text-slate-400">Admin</div>
        <div class="mt-1 text-2xl font-extrabold text-white">방명록 / 참여 신청 확인</div>
        <div class="mt-2 text-sm text-slate-300">비밀번호(0718)로 조회/삭제합니다.</div>
      </div>
      <a href="./index.html" class="text-sm text-slate-200 underline">메인으로</a>
    </div>

    <div class="mt-5 card rounded-2xl p-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="lg:col-span-2">
          <label class="text-xs text-slate-300">API_BASE_URL</label>
          <input id="api" class="mt-2 w-full input rounded-xl px-3 py-3 outline-none" placeholder="https://YOUR-BACKEND.onrender.com" />
        </div>
        <div>
          <label class="text-xs text-slate-300">관리자 비밀번호</label>
          <input id="pass" type="password" class="mt-2 w-full input rounded-xl px-3 py-3 outline-none" placeholder="0718" />
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnSave" class="btn2 px-4 py-2 rounded-lg text-sm">설정 저장</button>
        <button id="btnLoadGb" class="btn px-4 py-2 rounded-lg text-sm">방명록 불러오기</button>
        <button id="btnLoadRv" class="btn px-4 py-2 rounded-lg text-sm">참여 신청 불러오기</button>
        <div id="status" class="text-sm text-slate-300 self-center"></div>
      </div>
    </div>

    <div class="mt-5 grid grid-cols-1 xl:grid-cols-2 gap-4">
      <div class="card rounded-2xl p-5 overflow-hidden">
        <div class="flex items-center justify-between">
          <div class="text-sm font-extrabold text-white">방명록</div>
          <div class="text-xs text-slate-400">삭제 가능</div>
        </div>
        <div class="mt-3 overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-300">
              <tr class="border-b border-slate-700">
                <th class="py-2 pr-2">ID</th>
                <th class="py-2 pr-2">시간</th>
                <th class="py-2 pr-2">이름</th>
                <th class="py-2 pr-2">메시지</th>
                <th class="py-2 pr-2">작업</th>
              </tr>
            </thead>
            <tbody id="gbBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl p-5 overflow-hidden">
        <div class="flex items-center justify-between">
          <div class="text-sm font-extrabold text-white">참여 신청</div>
          <div class="text-xs text-slate-400">목록 조회</div>
        </div>
        <div class="mt-3 overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-300">
              <tr class="border-b border-slate-700">
                <th class="py-2 pr-2">ID</th>
                <th class="py-2 pr-2">시간</th>
                <th class="py-2 pr-2">이름</th>
                <th class="py-2 pr-2">연락처</th>
                <th class="py-2 pr-2">여부</th>
                <th class="py-2 pr-2">인원</th>
                <th class="py-2 pr-2">메모</th>
              </tr>
            </thead>
            <tbody id="rvBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function clean(s){ return String(s || "").trim(); }
    function esc(s){
      return String(s || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setStatus(msg, bad=false){
      $("status").textContent = msg || "";
      $("status").className = "text-sm self-center " + (bad ? "text-rose-300" : "text-emerald-300");
      if(!msg) $("status").className = "text-sm text-slate-300 self-center";
    }

    function saveSettings(){
      const api = clean($("api").value);
      localStorage.setItem("hb_api", api);
      sessionStorage.setItem("hb_pass", clean($("pass").value));
      setStatus("설정 저장 완료");
    }

    function loadSettings(){
      const api = localStorage.getItem("hb_api") || "";
      const pass = sessionStorage.getItem("hb_pass") || "";
      if(api) $("api").value = api;
      if(pass) $("pass").value = pass;
    }

    function headers(){
      return {"x-admin-pass": clean($("pass").value)};
    }

    async function loadGb(){
      const api = clean($("api").value);
      if(!api){ setStatus("API_BASE_URL을 입력해 주세요.", true); return; }
      setStatus("방명록 불러오는 중...");
      $("gbBody").innerHTML = "";
      try{
        const res = await fetch(api + "/api/guestbook?limit=300");
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data.detail || ("HTTP " + res.status));
        const items = Array.isArray(data.items) ? data.items : [];
        $("gbBody").innerHTML = items.map(it => `
          <tr class="border-t border-slate-800 align-top">
            <td class="py-2 pr-2">${esc(it.id)}</td>
            <td class="py-2 pr-2 whitespace-nowrap">${esc(it.created_at)}</td>
            <td class="py-2 pr-2">${esc(it.name)}</td>
            <td class="py-2 pr-2 max-w-[320px]">${esc(it.message)}</td>
            <td class="py-2 pr-2">
              <button data-gbdel="${esc(it.id)}" class="btn2 px-3 py-1.5 rounded-lg text-xs">삭제</button>
            </td>
          </tr>
        `).join("");
        bindGbDelete(api);
        setStatus("방명록 " + items.length + "건");
      }catch(e){
        setStatus("불러오기 실패: " + (e.message || "unknown"), true);
      }
    }

    function bindGbDelete(api){
      document.querySelectorAll("[data-gbdel]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-gbdel");
          await delGb(api, id);
        });
      });
    }

    async function delGb(api, id){
      try{
        const res = await fetch(api + "/api/guestbook/" + encodeURIComponent(id), {
          method: "DELETE",
          headers: headers()
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok || !data.ok) throw new Error(data.detail || ("HTTP " + res.status));
        setStatus("삭제 완료");
        await loadGb();
      }catch(e){
        setStatus("삭제 실패: " + (e.message || "unknown"), true);
      }
    }

    async function loadRv(){
      const api = clean($("api").value);
      if(!api){ setStatus("API_BASE_URL을 입력해 주세요.", true); return; }
      setStatus("참여 신청 불러오는 중...");
      $("rvBody").innerHTML = "";
      try{
        const res = await fetch(api + "/api/rsvp?limit=500", {headers: headers()});
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data.detail || ("HTTP " + res.status));
        const items = Array.isArray(data.items) ? data.items : [];
        $("rvBody").innerHTML = items.map(it => `
          <tr class="border-t border-slate-800 align-top">
            <td class="py-2 pr-2">${esc(it.id)}</td>
            <td class="py-2 pr-2 whitespace-nowrap">${esc(it.created_at)}</td>
            <td class="py-2 pr-2">${esc(it.name)}</td>
            <td class="py-2 pr-2">${esc(it.contact)}</td>
            <td class="py-2 pr-2">${esc(it.attend)}</td>
            <td class="py-2 pr-2">${esc(it.people)}</td>
            <td class="py-2 pr-2 max-w-[260px]">${esc(it.memo || "")}</td>
          </tr>
        `).join("");
        setStatus("참여 신청 " + items.length + "건");
      }catch(e){
        setStatus("불러오기 실패: " + (e.message || "unknown"), true);
      }
    }

    $("btnSave").addEventListener("click", saveSettings);
    $("btnLoadGb").addEventListener("click", loadGb);
    $("btnLoadRv").addEventListener("click", loadRv);

    loadSettings();
  </script>
</body>
</html>
