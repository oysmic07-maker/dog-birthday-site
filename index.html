<style>
  /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
  .del-btn {
    background: #ff4d4d; color: white; border: none;
    padding: 4px 8px; border-radius: 6px; cursor: pointer;
    font-size: 11px; float: right; transition: 0.2s;
  }
  .del-btn:hover { background: #cc0000; }
  
  /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ ê°œì„  */
  input, textarea { border: 1px solid var(--line); border-radius: 10px; padding: 10px; width: 100%; margin-bottom: 8px; }
  .btnPrimary { background: var(--gold); color: white; border: none; font-weight: bold; width: 100%; padding: 12px; }
</style>

<body>
  <div class="wrap">
    <div class="card">
      <div class="ribbon reveal">
        <span class="pill" id="apiPill">API: ì—°ê²° í™•ì¸ ì¤‘</span>
        <button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btnPrimary" onclick="checkAdminAccess()">ê´€ë¦¬ì</button>
      </div>

      <div class="section reveal">
        <h2 class="secTitle">ë°©ëª…ë¡ ë‚¨ê¸°ê¸°</h2>
        <div class="panel">
          <input id="gName" placeholder="ì‘ì„±ì ì´ë¦„" maxlength="10">
          <textarea id="gMsg" placeholder="ì—°ìœ ì—ê²Œ ì¶•í•˜ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!" maxlength="200"></textarea>
          <button class="btn btnPrimary" id="btnPost">ì¶•í•˜ ë©”ì‹œì§€ ì €ì¥í•˜ê¸° âœ¨</button>
          <div id="postMsg" class="msg warn" style="margin-top:10px; text-align:center;"></div>
        </div>
      </div>

      <div class="section reveal">
        <h2 class="secTitle">ì¶•í•˜ì˜ ê¸€ë“¤</h2>
        <div id="list" class="list">
          </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = "https://dog-birthday-api.onrender.com";
    const ADMIN_PW = "1234"; // ì‹¤ì œ ìš´ì˜ ì‹œ ë³´ì•ˆì„ ìœ„í•´ ì„œë²„ì—ì„œ ê²€ì¦í•´ì•¼ í•˜ë‚˜, í˜„ì¬ ë‹¨ê³„ì—ì„œ 1ì°¨ ì°¨ë‹¨ìš©

    // 1. ê´€ë¦¬ì ì ‘ê·¼ ì œì–´
    function checkAdminAccess() {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (pw === ADMIN_PW) {
        // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì‹œ ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™ (ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ë“±ìœ¼ë¡œ ê¶Œí•œ ì „ë‹¬ ê°€ëŠ¥)
        location.href = "./admin.html?token=" + btoa(pw); 
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      }
    }

    // 2. ë°©ëª…ë¡ ì €ì¥ ê¸°ëŠ¥ (POST)
    async function postGuestbook() {
      const name = document.getElementById("gName").value.trim();
      const message = document.getElementById("gMsg").value.trim();
      const out = document.getElementById("postMsg");

      if (!name || !message) {
        out.textContent = "ì´ë¦„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì ì–´ì£¼ì„¸ìš”!";
        return;
      }

      try {
        out.textContent = "ì €ì¥ ì¤‘...";
        const response = await fetch(`${API_BASE_URL}/api/guestbook`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, message })
        });

        if (response.ok) {
          out.textContent = "ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰";
          document.getElementById("gName").value = "";
          document.getElementById("gMsg").value = "";
          loadGuestbook(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        } else {
          throw new Error("ì €ì¥ ì‹¤íŒ¨");
        }
      } catch (e) {
        out.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
      }
    }

    // 3. ë°©ëª…ë¡ ì‚­ì œ ê¸°ëŠ¥ (DELETE)
    async function deleteEntry(id) {
      if (!confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      try {
        const response = await fetch(`${API_BASE_URL}/api/guestbook/${id}`, {
          method: "DELETE"
        });
        if (response.ok) {
          alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadGuestbook();
        }
      } catch (e) {
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // 4. ë°©ëª…ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
    async function loadGuestbook() {
      const listEl = document.getElementById("list");
      listEl.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      try {
        const response = await fetch(`${API_BASE_URL}/api/guestbook`);
        const data = await response.json();
        const rows = Array.isArray(data) ? data : data.items;

        listEl.innerHTML = "";
        rows.forEach(item => {
          const div = document.createElement("div");
          div.className = "item reveal";
          div.innerHTML = `
            <div class="meta">
              <span class="name"><b>${item.name}</b></span>
              <span class="ts">${new Date(item.created_at || Date.now()).toLocaleDateString()}</span>
              <button class="del-btn" onclick="deleteEntry('${item._id || item.id}')">ì‚­ì œ</button>
            </div>
            <div class="txt" style="margin-top:8px">${item.message}</div>
          `;
          listEl.appendChild(div);
        });
        // ìƒˆë¡œ ìƒê¸´ ìš”ì†Œë“¤ì— ì• ë‹ˆë©”ì´ì…˜ ì ìš©
        applyReveal();
      } catch (e) {
        listEl.innerHTML = "ë°©ëª…ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }
    }

    // ì´ˆê¸° ì‹¤í–‰
    document.getElementById("btnPost").onclick = postGuestbook;
    document.getElementById("btnReload").onclick = loadGuestbook;
    loadGuestbook();

    // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    function applyReveal() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) entry.target.classList.add('active');
        });
      }, { threshold: 0.1 });
      document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
    }
    applyReveal();
  </script>
</body>
